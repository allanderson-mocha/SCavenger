#define F_CPU 16000000UL
#include <avr/io.h>
#include <util/delay.h>

// LCD Pin Definitions
#define LCD_RS    PB4
#define LCD_E     PB3
#define LCD_D4    PB2
#define LCD_D5    PB1
#define LCD_D6    PB0
#define LCD_D7    PD7

// DDR and PORT definitions
#define LCD_CTRL_DDR  DDRB
#define LCD_CTRL_PORT PORTB
#define LCD_DATA_DDR  DDRD
#define LCD_DATA_PORT PORTD

void lcd_toggle_enable() {
    LCD_CTRL_PORT |= (1 << LCD_E);
    _delay_us(1);
    LCD_CTRL_PORT &= ~(1 << LCD_E);
    _delay_us(100);
}

void lcd_send_nibble(uint8_t nibble) {
    // Send D4-D7 using PB2-PB0, PD7
    if (nibble & 0x01) LCD_CTRL_PORT |=  (1 << LCD_D4); else LCD_CTRL_PORT &= ~(1 << LCD_D4);
    if (nibble & 0x02) LCD_CTRL_PORT |=  (1 << LCD_D5); else LCD_CTRL_PORT &= ~(1 << LCD_D5);
    if (nibble & 0x04) LCD_CTRL_PORT |=  (1 << LCD_D6); else LCD_CTRL_PORT &= ~(1 << LCD_D6);
    if (nibble & 0x08) LCD_DATA_PORT |=  (1 << LCD_D7); else LCD_DATA_PORT &= ~(1 << LCD_D7);

    lcd_toggle_enable();
}

void lcd_command(uint8_t cmd) {
    LCD_CTRL_PORT &= ~(1 << LCD_RS); // RS = 0 (command)
    lcd_send_nibble(cmd >> 4);
    lcd_send_nibble(cmd & 0x0F);
    _delay_ms(2);
}

void lcd_data(uint8_t data) {
    LCD_CTRL_PORT |= (1 << LCD_RS); // RS = 1 (data)
    lcd_send_nibble(data >> 4);
    lcd_send_nibble(data & 0x0F);
    _delay_ms(2);
}

void lcd_init() {
    // Set control and data pins as output
    LCD_CTRL_DDR |= (1 << LCD_RS) | (1 << LCD_E) |
                    (1 << LCD_D4) | (1 << LCD_D5) | (1 << LCD_D6);
    LCD_DATA_DDR  |= (1 << LCD_D7);

    _delay_ms(40); // Wait for LCD to power up

    // Initialization Sequence
    lcd_send_nibble(0x03); _delay_ms(5);
    lcd_send_nibble(0x03); _delay_us(150);
    lcd_send_nibble(0x03); _delay_us(150);
    lcd_send_nibble(0x02); // Set to 4-bit mode

    lcd_command(0x28); // 4-bit, 2 line, 5x8 dots
    lcd_command(0x0C); // Display ON, Cursor OFF
    lcd_command(0x06); // Entry mode set
    lcd_command(0x01); // Clear display
    _delay_ms(2);
}

void lcd_puts(const char *str) {
    while (*str) {
        lcd_data(*str++);
    }
}

int main(void) {
    lcd_init();              // Initialize LCD
    lcd_puts("Hello, World!"); // Print test message

    while (1) {
        // Loop forever
    }
}
